<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}"/>
  <title th:text="${pv.id != null} ? 'Editar emisión' : 'Nueva emisión'">Formulario</title>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
  <h1 th:text="${pv.id != null} ? 'Editar emisión' : 'Nueva emisión'"></h1>

  <form th:action="@{${pv.id != null} ? '/primera_vez/edit/' + ${pv.id} : '/primera_vez/new/' + ${pv.jokeId}}"
        th:object="${pv}"
        method="post">

    <!-- Si ya existe, incluimos el id oculto -->
    <input type="hidden" th:if="${pv.id != null}" th:field="*{id}"/>

    <!-- Selección de Joke -->
    <div class="mb-3">
      <label for="joke" class="form-label">Joke</label>
      <select id="joke" th:field="*{jokeId}" class="form-select">
        <option th:each="j : ${jokes}"
                th:value="${j.id}"
                th:text="${j.id} + ' – ' + j.text1"
                th:selected="${j.id == pv.jokeId}"></option>
      </select>
    </div>

    <!-- Programa -->
    <div class="mb-3">
      <label for="programa" class="form-label">Programa</label>
      <input type="text" id="programa" th:field="*{programa}" class="form-control"/>
    </div>

    <!-- Fecha de emisión -->
    <div class="mb-3">
      <label for="fechaEmision" class="form-label">Fecha Emisión</label>
      <input type="datetime-local" id="fechaEmision"
             th:field="*{fechaEmision}" class="form-control"/>
    </div>

    <!-- Teléfonos -->
    <div class="mb-3">
      <label class="form-label">Teléfonos</label>
      <div th:each="t, idx : ${pv.telefonos}" class="input-group mb-2">
        <input type="text"
               th:field="*{telefonos[__${idx}__].numero}"
               class="form-control"
               placeholder="Número"/>
        <button type="button" class="btn btn-outline-danger"
                onclick='this.closest(".input-group").remove();'>
          ✖
        </button>
      </div>

      <!-- Botón para añadir dinámicamente otro input -->
      <button type="button" class="btn btn-outline-primary mb-3"
              onclick="
                  const form = this.closest('form');
                  const idx = form.querySelectorAll('.input-group').length;
                  const tpl = `
                    <div class='input-group mb-2'>
                      <input type='text' name='telefonos[${idx}].numero'
                             class='form-control' placeholder='Número'/>
                      <button type='button' class='btn btn-outline-danger'
                              onclick='this.closest(\".input-group\").remove();'>
      ✖
      </button>
    </div>`;
    form.insertBefore(
    document.createRange().createContextualFragment(tpl),
    this
    );
    ">
    + Teléfono
    </button>
</div>

<!-- Botones de acción -->
<button type="submit" class="btn btn-success">Guardar</button>
<a th:href="@{/primera_vez}" class="btn btn-secondary">Cancelar</a>

</form>
</div>

<div th:replace="fragments/footer :: footer"></div>
</body>
</html>